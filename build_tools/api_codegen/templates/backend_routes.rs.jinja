// Auto-generated by build_tools/api_codegen. Do not edit manually.
#![allow(clippy::all)]
#![cfg_attr(rustfmt, rustfmt_skip)]

use std::collections::HashMap;
use std::sync::Arc;
{% if use_optional_query %}use std::future::Future;
{% endif %}

use axum::{
    extract::{
        Extension{% if use_path %}, Path{% endif %}{% if use_query %}, Query{% endif %}{% if use_json %}, Json{% endif %}{% if use_optional_query %}, FromRequest, FromRequestParts, Request{% endif %}
    },
    {% if use_optional_query %}body::Body,{% endif %}
    routing::{ {{ routing_imports|join(", ") }} },
    Router,
    {% if use_header_map %}http::HeaderMap,{% endif %}
    {% if use_response %}response::Response,{% endif %}
};
{% if use_optional_query %}
use axum::extract::rejection::QueryRejection;
use serde::de::DeserializeOwned;
{% endif %}
use serde_json::Value;
use tracing::instrument;

use crate::{
    error::ApiError,
    state::AppState,
};

pub fn register_routes(router: Router) -> Router {
    router
{% for route in routes %}
        .route("{{ route.axum_path }}", {{ route.method_chain }})
{% endfor %}
}

{% if use_optional_query %}
#[derive(Debug)]
pub struct OptionalQuery<T>(Option<Query<T>>);

impl<T> OptionalQuery<T> {
    fn into_option(self) -> Option<Query<T>> {
        self.0
    }
}

impl<T, S> FromRequest<S, Body> for OptionalQuery<T>
where
    T: DeserializeOwned,
    S: Send + Sync,
{
    type Rejection = QueryRejection;

    fn from_request(
        req: Request<Body>,
        state: &S,
    ) -> impl Future<Output = Result<Self, Self::Rejection>> + Send {
        let state_ref = state;

        async move {
            let (mut parts, _) = req.into_parts();

            if parts.uri.query().is_none() {
                return Ok(Self(None));
            }

            Query::<T>::from_request_parts(&mut parts, state_ref)
                .await
                .map(|query| Self(Some(query)))
        }
    }
}
{% endif %}

{% for op in operations %}
{% set params = ["Extension(state): Extension<Arc<AppState>>"] %}
{% if op.needs_headers %}
{% set _ = params.append("headers: HeaderMap") %}
{% endif %}
{% if op.has_path_params %}{% set _ = params.append("Path(path): Path<HashMap<String, String>>") %}{% endif %}
{% if op.has_query_params %}{% set _ = params.append("query: OptionalQuery<HashMap<String, String>>") %}{% endif %}
{% if op.has_body %}{% set _ = params.append("body: Option<Json<Value>>") %}{% endif %}
{% set delegate_args = ["Extension(state)"] %}
{% if op.needs_headers %}{% set _ = delegate_args.append("headers") %}{% endif %}
{% if op.has_path_params %}{% set _ = delegate_args.append("Path(path)") %}{% endif %}
{% if op.has_query_params %}{% set _ = delegate_args.append("query") %}{% endif %}
{% if op.has_body %}{% set _ = delegate_args.append("body") %}{% endif %}
#[allow(clippy::unused_async)]
#[instrument(skip_all, fields(method = "{{ op.method|upper }}", path = "{{ op.path }}"))]
pub async fn {{ op.handler_name }}(
    {{ params | join(",\n    ") }},
) -> {{ op.rust_return_type }} {
    {% if op.has_query_params %}
    let query = query.into_option();
    {% endif %}
    {% if op.has_path_params %}
    // Clone path so we can both audit and forward the Path to handlers without moving
    let path_params = path.clone();
    {% else %}
    let path_params: HashMap<String, String> = HashMap::new();
    {% endif %}

    {% if op.has_query_params %}
    let query_params = query
        .as_ref()
        .map(|value| value.0.clone())
        .unwrap_or_default();
    {% else %}
    let query_params: HashMap<String, String> = HashMap::new();
    {% endif %}

    {% if op.has_body %}
    let body_value = body
        .as_ref()
        .map(|payload| payload.0.clone())
        .unwrap_or(Value::Null);
    {% else %}
    let body_value = Value::Null;
    {% endif %}

    state
        .audit_request(
            "{{ op.method|upper }}",
            "{{ op.path }}",
            &path_params,
            &query_params,
            &body_value,
        )
        .await?;

    {% if op.delegate_target %}
    {{ op.delegate_target }}(
        {{ delegate_args | join(",\n        ") }},
    ).await
    {% else %}
    Err(ApiError::not_implemented("{{ op.handler_name }}"))
    {% endif %}
}
{% endfor %}
